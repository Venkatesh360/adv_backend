# Alembic Versioned Migrations: In-Depth Guide

Alembic is a powerful database migration tool used with SQLAlchemy. It allows you to track schema changes over time, create reproducible upgrade and downgrade paths, and maintain consistency between development, staging, and production databases.

---

## 🚀 Why Versioned Migrations?

Versioned migrations let you:

- **Track schema changes** alongside your code.
- **Reproduce environments** across multiple machines or team members.
- **Rollback** problematic changes.
- **Deploy** changes incrementally and safely.

---

## 📦 Installation

To get started, install Alembic:

```bash
pip install alembic
```

If you use Poetry:

```bash
poetry add alembic --dev
```

---

## 🏗️ Project Setup & Initialization

Navigate to your project directory and run:

```bash
alembic init alembic
```

This generates:

```
alembic.ini             # Main config file
alembic/
├── env.py             # Migration environment setup
├── script.py.mako     # Template for new migrations
└── versions/          # Stores generated migration scripts
```

Next, configure your database connection in `alembic.ini`:

```ini
sqlalchemy.url = postgresql://user:password@localhost/dbname
```

Or dynamically set it in `env.py` using environment variables for better security.

---

## 🔍 Autogeneration & Revision Creation

If you're using SQLAlchemy models, ensure they are correctly imported in `env.py`. Then run:

```bash
alembic revision --autogenerate -m "Add users table"
```

This generates a migration file with `upgrade()` and `downgrade()` functions under `alembic/versions/`.

Review the autogenerated migration carefully—it may miss complex changes like column renaming.

---

## 💾 Applying & Downgrading Migrations

To apply all unapplied migrations:

```bash
alembic upgrade head
```

To rollback the latest migration:

```bash
alembic downgrade -1
```

To upgrade/downgrade to a specific revision:

```bash
alembic upgrade <revision_id>
alembic downgrade <revision_id>
```

---

## 🔗 Managing Version History

Check the current migration version applied to the DB:

```bash
alembic current
```

To list all migrations:

```bash
alembic history
```

To view a specific revision’s details:

```bash
alembic show <revision_id>
```

---

## ⚙️ Manual Migration File Example

```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer, primary_key=True),
        sa.Column('name', sa.String, nullable=False)
    )

def downgrade():
    op.drop_table('users')
```

---

## ✅ Best Practices

- Always **review autogenerations**.
- Store the `alembic.ini` DB URL in an **env var**, not in source control.
- Run `alembic upgrade head` in **CI pipelines** before deploying code.
- **Use descriptive messages** in `-m "..."` to easily trace history.
- Keep your **SQLAlchemy models in sync** with migrations.

---

## 📚 References

- [Official Alembic Docs](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Docs](https://docs.sqlalchemy.org/)
- [Using Alembic with FastAPI](https://fastapi.tiangolo.com/tutorial/sql-databases/#alembic-migrations)

---

## 🔄 Summary Workflow

1. Define/update models.
2. Run `alembic revision --autogenerate -m "..."`
3. Review and edit the script.
4. Run `alembic upgrade head`
5. Commit the migration file.
